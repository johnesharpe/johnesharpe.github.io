<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR.js Augmented Reality</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">

    <!-- Add your 3D model entity -->
    <a-entity id="model" scale="0.1 0.1 0.1"></a-entity>

    <!-- Script to handle zip file upload and extraction -->
    <script>
      function extractZipFile(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
          var zip = new JSZip();
          zip.loadAsync(e.target.result).then(function(contents) {
            // Find the .gltf file in the zip
            var gltfFile = null;
            contents.forEach(function(relativePath, file) {
              if (relativePath.endsWith('.gltf')) {
                gltfFile = file;
              }
            });

            if (gltfFile) {
              // Read the .gltf file contents
              gltfFile.async('text').then(function(gltfContent) {
                // Set the .gltf model
                var model = document.getElementById('model');
                model.setAttribute('gltf-model', URL.createObjectURL(new Blob([gltfContent], {type: 'text/plain'})));

                // Extract and set other resources
                var basePath = gltfFile.name.substr(0, gltfFile.name.lastIndexOf('/') + 1);
                contents.forEach(function(relativePath, file) {
                  if (!relativePath.endsWith('.gltf')) {
                    file.async('blob').then(function(resourceContent) {
                      var url = URL.createObjectURL(resourceContent);
                      model.setAttribute('gltf-model', 'src: url(' + url + ')');
                    });
                  }
                });
              });
            } else {
              console.error('No .gltf file found in the uploaded zip.');
            }
          });
        };
        reader.readAsArrayBuffer(file);
      }

      // Automatically extract and display zip contents upon file selection
      window.addEventListener('DOMContentLoaded', function() {
        var modelUpload = document.getElementById('modelUpload');
        modelUpload.addEventListener('change', function(event) {
          var file = event.target.files[0];
          extractZipFile(file);
        });

        // Automatically trigger the file input click
        var fileInput = document.getElementById('modelUpload');
        fileInput.click();
      });
    </script>

    <!-- Hidden file input element -->
    <input type="file" id="modelUpload" accept=".zip" style="display: none;">

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
